<style>
  :root{
   --ms-color-bg: #FFF;
  }
  :root.dark{
   --ms-color-bg: #000;
  }
  .ms-color-palette{
    font-size:0;
  }
  .ms-color-palette .ms-color-gradient:nth-child(10n){
    margin-right: 20px;
  }
  .ms-color-palette .ms-color-gradient:nth-child(20n){
   display: table-column;
  }
  .ms-color-gradient{
    display: inline-block;
    position: relative;
    width: 20px;
    height:20px;
    margin-bottom: 15px;
    margin-right: 5px;
    transition-duration:0.1s;
  }
  .ms-color-gradient:hover{
    transform:scale(1.5);
    z-index: 999;
  }

  .ms-color-edit-picker>div{
    border-color: transparent !important;
  }
  .ms-color-edit-picker i{
    display: none;
  }
  .ms-color-edit-picker span{
    border-color: #5f5f60;
  }
  .ms-color-edit-picker .layui-colorpicker-trigger-bgcolor{
    display: inline;
  }

</style>
<div style="padding: 20px;background-color: var(--ms-color-bg);">
  <div style="display: flex;justify-content: space-between;align-items: center;">
    <div >
      <label style="display: flex;" title="降低饱和度，提高亮度，看起来更舒适">
        <input name="colorpicker" type="checkbox" style="height: 18px; width: 18px;">深色色板
      </label>
    </div>
    <div>
      <span title="重置"><i id="resetTheme" style="font-size: 25px;" class="layui-icon layui-icon-refresh"></i></span>
      <span title="下载"><i id="downloadCSS" style="font-size: 25px;" class="layui-icon layui-icon-download-circle"></i></span>
    </div>
  </div>
  <hr>
  <div class="ms-color-palette">
    <!-- 色板 tpl 生成 -->
  </div>
  <div class="ms-color-edit">
    <!-- 编辑区 tpl 生成 -->
  </div>
</div>

<template id="tpl-color-palette">
  {{# layui.each(d.ColorPaletteLight, function(key, val){  }}
    <div class="ms-color-gradient" style="background-color: var({{- key }});" title="{{- key.replace('--lay-color-','') }}"></div>
  {{#  })  }}
</template>

<template id="tpl-color-editable">
  {{# layui.each(d.editable, function(key, val){ }}
    <div style="display: flex; align-items: center; height:30px">
      <div>{{= key }}</div>
      <div style="flex: 1 1 auto;"></div>
      <input type="text" name="color" value="{{= val }}" placeholder=""
        style="text-align: right;height:28px;width: 150px;background-color: transparent;border-color: transparent;">
      <div class="ms-color-edit-picker" lay-options="{color: '{{= val }}', format: '{{- /^rgb/.test(val) ? 'rgb':'hex'  }}' }" data-key="{{= key}}"></div>
    </div>
  {{# }) }}
</template>

<script>
  layui.use(async ()=> {
    const {jquery:$,laytpl,colorpicker} = layui;
    
    const originalData=await (await fetch('./docs/themes.json')).json()
    let customTheme = {};
    
    laytpl($('#tpl-color-palette').html()).render(originalData,function(str) {
      $('.ms-color-palette').html(str);
    });

    laytpl($('#tpl-color-editable').html()).render(originalData,function(str) {
      $('.ms-color-edit').html(str);
      renderColorPicker();
    });

    $('input[name=colorpicker]').on('click',function(){
      applyColorPalette(this.checked)
    })
    $('#resetTheme').on('click',function(){
       resetTheme()
       $('input[name=colorpicker]').prop('checked',false)
    })
    $('#downloadCSS').on('click',function(){
       dropdownCSS()
    })

    function renderColorPicker(){
      colorpicker.render({
        elem: '.ms-color-edit-picker',
        alpha: true,
        change: function(color) {
          const elem=this.elem
          elem.prev().val(color)
          applyTheme(elem.data('key'),color)
        },
        done: function(color) {
          const elem=this.elem
          elem.prev().val(color)
          applyTheme(elem.data('key'),color)
        },
        close: function(color){
          const elem=this.elem
          elem.prev().val(color)
          applyTheme(elem.data('key'),color)
        }
      });
    }

    function resetTheme() {
      customTheme={}
      addStyle('demo-customTheme',getCSS(customTheme))
      renderColorPicker()
    }

    function applyTheme(key,val){
      customTheme = {...customTheme,...{[key]:val} }
      addStyle('demo-customTheme',getCSS(customTheme))
    }

    function applyColorPalette(isDark=false){
      customTheme={...customTheme, ...originalData[isDark ? 'ColorPaletteDark' : 'ColorPaletteLight']}
      addStyle('demo-customTheme',getCSS(customTheme))
    }

    function getCSS(cssVarsObj){
      return `:root {\n ${
        Object.entries(cssVarsObj)
          .map(([key,val])=> `  ${key}: ${val};`)
          .join('\n')
      }\n}`
    }

    async function dropdownCSS(){
      const overrideCSS = await(await fetch('./src/override.css')).text()
      const finalCSS = `${getCSS({...originalData.Default, ...customTheme})}\n${overrideCSS}`;
      const alink=document.createElement("a");
      alink.download='layui-theme-dark-custom.css';
      alink.href=URL.createObjectURL(new Blob([finalCSS]))
      document.body.appendChild(alink);
      alink.click();
      document.body.removeChild(alink);
    }

    function addStyle(id,cssStr) {
      var el=document.getElementById(id)||document.createElement('style')
      if(!el.isConnected) {
        el.type='text/css';
        el.id=id;
        document.head.appendChild(el);
      }
      el.textContent=cssStr;
    }
  })
</script>